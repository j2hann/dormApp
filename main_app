import tkinter as tk
from tkinter import messagebox, ttk, filedialog
import os
import sqlite3
from database_manager import DatabaseManager

class DormApp(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("CASALINKED: Dormitory Search and Management System")
        self.geometry("1000x700")
        self.configure(bg="white")
        
        self.db = DatabaseManager()
        self.currentUser = None
        
        # Main container
        self.container = tk.Frame(self, bg="white")
        self.container.pack(fill="both", expand=True)
        
        self.frames = {}
        
        for F in (StartupPage, LoginPage, RegisterPage, MainSystem):
            pageName = F.__name__
            frame = F(parent=self.container, controller=self)
            self.frames[pageName] = frame
            frame.grid(row=0, column=0, sticky="nsew")
        
        self.container.grid_rowconfigure(0, weight=1)
        self.container.grid_columnconfigure(0, weight=1)
        
        self.showFrame("StartupPage")

    def showFrame(self, pageName, data=None):
        frame = self.frames[pageName]
        frame.tkraise()
        if hasattr(frame, "onShow"):
            frame.onShow(data)

    def login(self, user):
        self.currentUser = user
        self.showFrame("MainSystem")
    
    def logout(self):
        self.currentUser = None
        self.showFrame("StartupPage")

    def updateDormRecord(self, dormId, location, details, price, contact):
        try:
            self.db.cursor.execute("""
                UPDATE dorms 
                SET location=?, details=?, price=?, contactInfo=?
                WHERE id=?
            """, (location, details, price, contact, dormId))
            self.db.conn.commit()
            return True
        except Exception as e:
            print(e)
            return False

    def deleteDormRecord(self, dormId):
        try:
            self.db.cursor.execute("DELETE FROM dorms WHERE id=?", (dormId,))
            self.db.conn.commit()
            return True
        except Exception:
            return False

class StartupPage(tk.Frame):
    def __init__(self, parent, controller):
        super().__init__(parent, bg="white")
        self.controller = controller
        
        box = tk.Frame(self, bg="light gray", padx=50, pady=50)
        box.place(relx=0.5, rely=0.5, anchor="center")
        
        tk.Label(box, text="Welcome to CASALINKED!", font=("Arial", 24, "bold"), bg="light gray", fg="black").pack(pady=20)
        tk.Label(box, text="Search & Manage Dorms", font=("Arial", 12), bg="light gray", fg="black").pack(pady=(0, 20))
        
        tk.Button(box, text="Login", width=20, bg="blue", fg="white", font=("Arial", 12, "bold"),
                  command=lambda: controller.showFrame("LoginPage")).pack(pady=10)
        
        tk.Button(box, text="Register", width=20, bg="green", fg="white", font=("Arial", 12, "bold"),
                  command=lambda: controller.showFrame("RegisterPage")).pack(pady=10)

class LoginPage(tk.Frame):
    def __init__(self, parent, controller):
        super().__init__(parent, bg="white")
        self.controller = controller
        
        box = tk.Frame(self, bg="white", highlightbackground="black", highlightthickness=1, padx=40, pady=40)
        box.place(relx=0.5, rely=0.5, anchor="center")
        
        tk.Label(box, text="User Login", font=("Arial", 20, "bold"), bg="white", fg="black").pack(pady=20)
        
        tk.Label(box, text="Email:", bg="white").pack(anchor="w")
        self.email = tk.Entry(box, width=30, bg="white", fg="black")
        self.email.pack(pady=5)
        
        tk.Label(box, text="Password:", bg="white").pack(anchor="w")
        self.pwd = tk.Entry(box, width=30, bg="white", fg="black", show="*")
        self.pwd.pack(pady=5)
        
        tk.Button(box, text="Enter", width=25, bg="blue", fg="white", command=self.handleLogin).pack(pady=20)
        tk.Button(box, text="Cancel", width=25, bg="white", fg="black", command=lambda: controller.showFrame("StartupPage")).pack()

    def handleLogin(self):
        user = self.controller.db.verifyUser(self.email.get(), self.pwd.get())
        if user:
            self.email.delete(0, tk.END)
            self.pwd.delete(0, tk.END)
            self.controller.login(user)
        else:
            messagebox.showerror("Error", "Invalid Email or Password")

class RegisterPage(tk.Frame):
    def __init__(self, parent, controller):
        super().__init__(parent, bg="white")
        self.controller = controller
        
        box = tk.Frame(self, bg="white", padx=40, pady=40)
        box.place(relx=0.5, rely=0.5, anchor="center")
        
        tk.Label(box, text="Create Account", font=("Arial", 20, "bold"), bg="white").pack(pady=20)
        
        self.fName = self.mkEntry(box, "First Name")
        self.lName = self.mkEntry(box, "Last Name")
        self.email = self.mkEntry(box, "Email")
        self.pwd = self.mkEntry(box, "Password", is_pass=True)
        
        tk.Button(box, text="Submit", width=25, bg="green", fg="white", command=self.handleRegister).pack(pady=20)
        tk.Button(box, text="Back", width=25, bg="white", fg="black", command=lambda: controller.showFrame("StartupPage")).pack()

    def mkEntry(self, parent, label, is_pass=False):
        tk.Label(parent, text=label, bg="white").pack(anchor="w")
        entry = tk.Entry(parent, width=30, bg="white", fg="black", show="*" if is_pass else "")
        entry.pack(pady=5)
        return entry

    def handleRegister(self):
        if self.controller.db.registerUser(self.fName.get(), self.lName.get(), self.email.get(), self.pwd.get()):
            messagebox.showinfo("Success", "Registered Successfully")
            self.controller.showFrame("StartupPage")
        else:
            messagebox.showerror("Error", "Registration Failed")

class MainSystem(tk.Frame):
    def __init__(self, parent, controller):
        super().__init__(parent, bg="white")
        self.controller = controller
        
        header = tk.Frame(self, bg="black", height=60, padx=20)
        header.pack(fill="x")
        
        tk.Label(header, text="Dormitory System", bg="black", fg="white", font=("Arial", 16, "bold")).pack(side="left", pady=15)
        tk.Button(header, text="Log Out", bg="red", fg="white", command=controller.logout).pack(side="right", pady=15)

        self.tabs = ttk.Notebook(self)
        self.tabs.pack(fill="both", expand=True, padx=10, pady=10)
        
        self.searchTab = SearchTab(self.tabs, controller)
        self.tabs.add(self.searchTab, text="  Find a Dorm  ")
        
        self.ownerTab = OwnerTab(self.tabs, controller)
        self.tabs.add(self.ownerTab, text="  My Dashboard (Manage)  ")

    def onShow(self, data=None):
        self.searchTab.refresh()
        self.ownerTab.refresh()

class SearchTab(tk.Frame):
    def __init__(self, parent, controller):
        super().__init__(parent, bg="white")
        self.controller = controller
        
        leftFrame = tk.Frame(self, bg="white", width=300)
        leftFrame.pack(side="left", fill="y", padx=10, pady=10)
        
        tk.Label(leftFrame, text="Available Dorms", bg="white", font=("Arial", 12, "bold")).pack(pady=5)
        tk.Button(leftFrame, text="Refresh List", bg="light gray", command=self.refresh).pack(fill="x", pady=5)
        
        self.listbox = tk.Listbox(leftFrame, width=30, height=25, bg="white", fg="black")
        self.listbox.pack(fill="both", expand=True)
        self.listbox.bind('<<ListboxSelect>>', self.showDetails)
        
        self.rightFrame = tk.Frame(self, bg="light gray", padx=20, pady=20)
        self.rightFrame.pack(side="right", fill="both", expand=True, padx=10, pady=10)
        
        self.lblTitle = tk.Label(self.rightFrame, text="Select a Dorm", font=("Arial", 18, "bold"), bg="light gray")
        self.lblTitle.pack(pady=10)
        
        self.lblDetails = tk.Label(self.rightFrame, text="", font=("Arial", 12), bg="light gray", justify="left", wraplength=400)
        self.lblDetails.pack(pady=10)

        self.lblPrice = tk.Label(self.rightFrame, text="", font=("Arial", 14, "bold"), fg="green", bg="light gray")
        self.lblPrice.pack(pady=10)

        self.ids = []

    def refresh(self):
        self.listbox.delete(0, tk.END)
        self.ids = []
        dorms = self.controller.db.getAllDorms()
        for d in dorms:
            self.ids.append(d[0])
            self.listbox.insert(tk.END, f"{d[2]} - ${d[4]}")

    def showDetails(self, event):
        sel = self.listbox.curselection()
        if not sel: return
        idx = sel[0]
        dId = self.ids[idx]
        
        data = self.controller.db.getDormById(dId)
        
        self.lblTitle.config(text=f"Location: {data[2]}")
        
        detail_text = (f"Details & Availability:\n{data[3]}\n\n"
                       f"Contact Owner: {data[5]}")
        self.lblDetails.config(text=detail_text)
        self.lblPrice.config(text=f"Price: â‚±{data[4]} / month")

class OwnerTab(tk.Frame):
    def __init__(self, parent, controller):
        super().__init__(parent, bg="white")
        self.controller = controller
        
        controlFrame = tk.Frame(self, bg="white", pady=10)
        controlFrame.pack(fill="x", padx=20)
        
        tk.Button(controlFrame, text="+ Add New Dorm", bg="blue", fg="white", command=self.addDormPopup).pack(side="left")
        tk.Button(controlFrame, text="Refresh My List", bg="light gray", command=self.refresh).pack(side="left", padx=10)
        tk.Button(controlFrame, text="Edit / Update Records", bg="orange", fg="black", command=self.editDormPopup).pack(side="right")
        tk.Button(controlFrame, text="Delete Selected", bg="red", fg="white", command=self.deleteDorm).pack(side="right", padx=10)
        
        cols = ("Location", "Price", "Status/Details", "Contact")
        self.tree = ttk.Treeview(self, columns=cols, show="headings")
        for c in cols:
            self.tree.heading(c, text=c)
        self.tree.pack(fill="both", expand=True, padx=20, pady=10)

    def refresh(self):
        for row in self.tree.get_children():
            self.tree.delete(row)
        
        all_dorms = self.controller.db.getAllDorms()
        my_id = self.controller.currentUser[0]
        
        for d in all_dorms:
            if d[1] == my_id:
                self.tree.insert("", tk.END, values=(d[2], d[4], d[3], d[5]), iid=d[0]) # store DB ID as iid

    def addDormPopup(self):
        self.popup("Add Dorm", is_edit=False)

    def editDormPopup(self):
        sel = self.tree.selection()
        if not sel:
            messagebox.showwarning("Select", "Please select a dorm to edit.")
            return
        
        dId = sel[0]
        data = self.controller.db.getDormById(dId)
        self.popup("Update Records", is_edit=True, data=data)

    def deleteDorm(self):
        sel = self.tree.selection()
        if not sel: return
        if messagebox.askyesno("Confirm", "Delete this record?"):
            self.controller.deleteDormRecord(sel[0])
            self.refresh()

    def popup(self, title, is_edit, data=None):
        win = tk.Toplevel(self)
        win.title(title)
        win.geometry("400x500")
        win.configure(bg="white")
        
        tk.Label(win, text=title, font=("Arial", 14, "bold"), bg="white").pack(pady=10)
        
        def row(lbl, val=""):
            tk.Label(win, text=lbl, bg="white").pack(anchor="w", padx=20)
            e = tk.Entry(win, width=40, bg="light gray")
            e.pack(padx=20, pady=5)
            e.insert(0, str(val))
            return e

        l_val = data[2] if data else ""
        p_val = data[4] if data else ""
        d_val = data[3] if data else ""
        c_val = data[5] if data else ""

        e_loc = row("Location", l_val)
        e_price = row("Price", p_val)
        
        tk.Label(win, text="Details / Tenant Status (Manage Record):", bg="white").pack(anchor="w", padx=20)
        e_details = tk.Entry(win, width=40, bg="light gray")
        e_details.pack(padx=20, pady=5)
        e_details.insert(0, str(d_val))
        
        e_contact = row("Contact Info", c_val)

        def save():
            if is_edit:
                self.controller.updateDormRecord(data[0], e_loc.get(), e_details.get(), e_price.get(), e_contact.get())
            else:
                self.controller.db.addDorm(self.controller.currentUser[0], e_loc.get(), e_details.get(), e_price.get(), e_contact.get(), "")
            
            win.destroy()
            self.refresh()

        tk.Button(win, text="Save Record", bg="green", fg="white", command=save).pack(pady=20)

if __name__ == "__main__":
    app = DormApp()
    app.mainloop()
